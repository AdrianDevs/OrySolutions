version: '3'

tasks:
  go:
    summary: Build and run the go binary standalone without the dockering it
    desc: Build and run the go binary standalone
    cmds:
      - go run .
    silent: true
  run:
      desc: Run build and start tasks
      cmds:
      - task:  build
      - task:  start
  build:
    desc: Compile app and package in a docker image
    dir: ../
    cmds:
      - echo 'Compile app and package in a docker image'
      - docker build --tag web-api-go -f web-api-go-dockerfile .
    silent: true
  start:
    desc: Run the docker image in a container
    cmds:
      - echo 'Run the docker image in a container'
      - docker run --detach --publish 3000:8090 web-api-go
    silent: true
  stop:
    desc: Stop the container
    cmds:
      - echo 'Stop the container'
      - docker stop $(docker ps -a -q --filter ancestor=web-api-go --format="{{.ID}}")
    silent: true
  clean:
    desc: Stop the container and remove Docker Web-API-Go Images
    cmds:
      - echo "Stop the container and remove Docker Web-API-Go Images"
      - defer: { task:  clean-images }
      - docker stop $(docker ps -a -q --filter ancestor=web-api-go --format="{{.ID}}")
      - docker rm $(docker ps -a -q --filter ancestor=web-api-go --format="{{.ID}}")
    silent: true
  clean-images:
    cmds:
      - docker image rm -f web-api-go
      # - docker image prune
    silent: true
